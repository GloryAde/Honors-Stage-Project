@page "/Inventory"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations

<PageTitle>Inventory Management - HSP Library</PageTitle>

<div class="container mt-5">
    <div class="page-header mb-5">
        <h1 class="display-4">Inventory Management</h1>
        <p class="lead">Manage your library's assets and equipment efficiently.</p>
        <hr class="my-4" />
    </div>

    <AuthorizeView Roles="Admin,Teacher">
        <Authorized>
            <div class="action-buttons mb-4">
                <button class="btn btn-primary" @onclick="ShowAddAssetForm">
                    <i class="bi bi-plus-circle"></i> Add New Asset
                </button>
                <button class="btn btn-success" @onclick="DownloadAssetListAsync" disabled="@(assets == null || !assets.Any())">
                    <i class="bi bi-download"></i> Download Asset List
                </button>
            </div>
        </Authorized>
    </AuthorizeView>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @message
            <button type="button" class="btn-close" @onclick="@(() => message = string.Empty)" aria-label="Close"></button>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)" aria-label="Close"></button>
        </div>
    }

    <AuthorizeView Roles="Admin,Teacher" Context="authContext">
        <Authorized>
            @if (showAddForm)
            {
                <div class="card modern-card mb-5">
                    <div class="card-header">
                        <h5><i class="bi bi-plus-square me-2"></i>Add New Asset</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="newAsset" OnValidSubmit="HandleAddAssetAsync">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="alert alert-danger" />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="assetName" class="form-label">
                                        <i class="bi bi-tag me-1"></i>Asset Name
                                    </label>
                                    <InputText id="assetName" class="form-control" @bind-Value="newAsset.Name" placeholder="e.g., Laptop Dell XPS 15" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="assetCategory" class="form-label">
                                        <i class="bi bi-folder me-1"></i>Category
                                    </label>
                                    <InputText id="assetCategory" class="form-control" @bind-Value="newAsset.Category" placeholder="e.g., Electronics, Books, Equipment" />
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <InputCheckbox id="assetAvailable" class="form-check-input" @bind-Value="newAsset.IsAvailable" />
                                    <label class="form-check-label" for="assetAvailable">
                                        <i class="bi bi-check-circle me-1"></i>Available for Loan
                                    </label>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-save me-2"></i>Save Asset
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CancelAddAsset">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            }
        </Authorized>
    </AuthorizeView>

    <div class="card modern-card">
        <div class="card-header">
            <h5><i class="bi bi-list-ul me-2"></i>Current Assets</h5>
        </div>
        <div class="card-body">
            @if (assets == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading assets...</p>
                </div>
            }
            else if (!assets.Any())
            {
                <div class="empty-state text-center py-5">
                    <i class="bi bi-inbox empty-icon"></i>
                    <h4 class="mt-3">No Assets Found</h4>
                    <p class="text-muted">Get started by adding your first asset to the inventory.</p>
                    <AuthorizeView Roles="Admin">
                        <Authorized>
                            <button class="btn btn-primary mt-3" @onclick="ShowAddAssetForm">
                                <i class="bi bi-plus-circle me-2"></i>Add Your First Asset
                            </button>
                        </Authorized>
                    </AuthorizeView>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table modern-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Status</th>
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <th>Actions</th>
                                    </Authorized>
                                </AuthorizeView>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var asset in assets)
                            {
                                <tr>
                                    <td><span class="badge bg-secondary">@asset.ItemId</span></td>
                                    <td class="fw-semibold">@asset.Name</td>
                                    <td>
                                        <i class="bi bi-folder-fill text-primary me-1"></i>
                                        @asset.Category
                                    </td>
                                    <td>
                                        @if (asset.IsAvailable)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>Available
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">
                                                <i class="bi bi-clock me-1"></i>On Loan
                                            </span>
                                        }
                                    </td>
                                    <AuthorizeView Roles="Admin">
                                        <Authorized>
                                            <td>
                                                <button class="btn btn-danger btn-sm" @onclick="@(() => DeleteAssetAsync(asset))" title="Delete asset">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </Authorized>
                                    </AuthorizeView>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer mt-3">
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Showing <strong>@assets.Count</strong> asset(s) in total
                    </p>
                </div>
            }
        </div>
    </div>
</div>
